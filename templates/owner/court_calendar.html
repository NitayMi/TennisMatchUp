{% extends "base.html" %}

{% block title %}Court Calendar - TennisMatchUp{% endblock %}

{% block extra_head %}
<link href="{{ url_for('static', filename='css/owner.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-tennis-green text-white py-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-calendar-alt me-2"></i>Court Calendar</h1>
                <p class="lead mb-0">Manage all your court bookings in one place</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light" onclick="calendar.today()">
                    <i class="fas fa-home me-2"></i>Today
                </button>
                <a href="{{ url_for('owner.booking_requests') }}" class="btn btn-outline-light">
                    <i class="fas fa-clipboard-list me-2"></i>Booking Requests
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-4">
    <!-- Calendar Controls -->
    <div class="row mb-3">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="calendar.prev()">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <h5 class="mb-0" id="calendar-title">Calendar</h5>
                            <button class="btn btn-outline-primary btn-sm" onclick="calendar.next()">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="calendar.changeView('dayGridMonth')">Month</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="calendar.changeView('timeGridWeek')">Week</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="calendar.changeView('timeGridDay')">Day</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6><i class="fas fa-filter me-2"></i>Filter by Court</h6>
                    <select class="form-select form-select-sm" id="court-filter" onchange="filterByGroup()">
                        <option value="">All Courts</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center gap-4">
                        <small><strong>Status Legend:</strong></small>
                        <span class="badge badge-confirmed">Confirmed</span>
                        <span class="badge badge-pending">Pending</span>
                        <span class="badge badge-cancelled">Cancelled</span>
                        <span class="badge badge-completed">Completed</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success" id="confirmed-count">0</h3>
                    <small class="text-muted">Confirmed Bookings</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning" id="pending-count">0</h3>
                    <small class="text-muted">Pending Requests</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info" id="revenue-total">$0</h3>
                    <small class="text-muted">Monthly Revenue</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary" id="utilization-rate">0%</h3>
                    <small class="text-muted">Court Utilization</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Details Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-check me-2"></i>Booking Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="booking-details">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div id="booking-actions">
                    <!-- Action buttons loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.fc-event {
    border: none !important;
    font-weight: 500;
    font-size: 0.875rem;
}

.fc-event-title {
    font-weight: 600;
}

.fc-daygrid-event {
    margin: 1px;
    padding: 2px 4px;
    border-radius: 4px;
}

.fc-timegrid-event {
    border-radius: 4px;
    padding: 2px 4px;
}

.fc-toolbar {
    margin-bottom: 1rem;
}

.fc-toolbar-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--tennis-green, #2E8B57);
}

.fc-button-primary {
    background-color: var(--tennis-green, #2E8B57) !important;
    border-color: var(--tennis-green, #2E8B57) !important;
}

.fc-button-primary:not(:disabled):active,
.fc-button-primary:not(:disabled).fc-button-active {
    background-color: #246945 !important;
    border-color: #246945 !important;
}

.fc-col-header-cell {
    background-color: #f8f9fa;
    font-weight: 600;
}

.fc-today-button {
    background-color: var(--tennis-green, #2E8B57) !important;
    border-color: var(--tennis-green, #2E8B57) !important;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

@media (max-width: 768px) {
    .fc-toolbar {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .fc-toolbar-chunk {
        display: flex;
        justify-content: center;
    }
}
</style>

<!-- Include FullCalendar CSS and JS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
let calendar;
let allEvents = [];
let currentCourts = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
    loadCalendarData();
});

function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: false, // We have custom toolbar
        height: 'auto',
        firstDay: 1, // Monday
        businessHours: {
            daysOfWeek: [1, 2, 3, 4, 5, 6, 0], // Monday - Sunday
            startTime: '08:00',
            endTime: '22:00'
        },
        slotMinTime: '06:00',
        slotMaxTime: '23:00',
        expandRows: true,
        dayMaxEvents: 3,
        moreLinkClick: 'popover',
        eventClick: function(info) {
            showBookingDetails(info.event);
        },
        datesSet: function(info) {
            updateCalendarTitle(info);
            updateQuickStats();
        },
        eventDidMount: function(info) {
            // Add tooltip
            info.el.setAttribute('title', 
                `${info.event.title}\n${info.event.extendedProps.court_name}\n${info.event.extendedProps.time_range}`
            );
        }
    });
    
    calendar.render();
}

async function loadCalendarData() {
    try {
        // Load bookings data
        const response = await fetch('/api/calendar/events');
        const data = await response.json();
        
        if (data.success) {
            allEvents = data.events.map(event => ({
                id: event.id,
                title: event.title,
                start: event.start,
                end: event.end,
                backgroundColor: event.color,
                borderColor: event.color,
                textColor: '#fff',
                extendedProps: {
                    status: event.status,
                    player_name: event.player_name,
                    court_name: event.court_name,
                    court_id: event.court_id,
                    cost: event.cost,
                    time_range: `${new Date(event.start).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})} - ${new Date(event.end).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}`
                }
            }));
            
            // Extract unique courts for filter
            currentCourts = [...new Set(data.events.map(e => ({
                id: e.court_id,
                name: e.court_name
            })))];
            
            populateCourtFilter();
            calendar.removeAllEvents();
            calendar.addEventSource(allEvents);
            updateQuickStats();
        } else {
            console.error('Failed to load calendar data:', data.error);
            showError('Failed to load calendar data');
        }
    } catch (error) {
        console.error('Error loading calendar data:', error);
        showError('Error loading calendar data');
    }
}

function populateCourtFilter() {
    const courtFilter = document.getElementById('court-filter');
    courtFilter.innerHTML = '<option value="">All Courts</option>';
    
    currentCourts.forEach(court => {
        const option = document.createElement('option');
        option.value = court.id;
        option.textContent = court.name;
        courtFilter.appendChild(option);
    });
}

function filterByGroup() {
    const selectedCourtId = document.getElementById('court-filter').value;
    
    calendar.removeAllEvents();
    
    if (selectedCourtId) {
        const filteredEvents = allEvents.filter(event => 
            event.extendedProps.court_id == selectedCourtId
        );
        calendar.addEventSource(filteredEvents);
    } else {
        calendar.addEventSource(allEvents);
    }
    
    updateQuickStats();
}

function updateCalendarTitle(info) {
    const titleEl = document.getElementById('calendar-title');
    if (titleEl) {
        titleEl.textContent = info.view.title;
    }
}

function updateQuickStats() {
    const visibleEvents = calendar.getEvents();
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    // Filter events for current month
    const monthlyEvents = visibleEvents.filter(event => {
        const eventDate = new Date(event.start);
        return eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear;
    });
    
    const confirmedBookings = monthlyEvents.filter(e => e.extendedProps.status === 'confirmed');
    const pendingBookings = monthlyEvents.filter(e => e.extendedProps.status === 'pending');
    
    // Update counters
    document.getElementById('confirmed-count').textContent = confirmedBookings.length;
    document.getElementById('pending-count').textContent = pendingBookings.length;
    
    // Calculate revenue
    const totalRevenue = confirmedBookings.reduce((sum, event) => 
        sum + (event.extendedProps.cost || 0), 0
    );
    document.getElementById('revenue-total').textContent = `${totalRevenue.toFixed(0)}`;
    
    // Calculate utilization (simplified)
    const totalPossibleSlots = currentCourts.length * 30 * 14; // courts * days * hours per day
    const bookedSlots = confirmedBookings.length * 2; // average 2 hours per booking
    const utilization = totalPossibleSlots > 0 ? (bookedSlots / totalPossibleSlots * 100) : 0;
    document.getElementById('utilization-rate').textContent = `${utilization.toFixed(0)}%`;
}

function showBookingDetails(event) {
    const modalEl = document.getElementById('bookingModal');
    const detailsEl = document.getElementById('booking-details');
    const actionsEl = document.getElementById('booking-actions');
    
    const props = event.extendedProps;
    const startTime = new Date(event.start);
    const endTime = new Date(event.end);
    
    // Format booking details
    detailsEl.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-user me-2"></i>Player Information</h6>
                <p class="mb-1"><strong>Name:</strong> ${props.player_name}</p>
                <p class="mb-3"><strong>Status:</strong> 
                    <span class="badge" style="background-color: ${event.backgroundColor}">
                        ${props.status.charAt(0).toUpperCase() + props.status.slice(1)}
                    </span>
                </p>
                
                <h6><i class="fas fa-tennis-ball me-2"></i>Court Information</h6>
                <p class="mb-1"><strong>Court:</strong> ${props.court_name}</p>
                <p class="mb-3"><strong>Time:</strong> ${props.time_range}</p>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-calendar me-2"></i>Booking Details</h6>
                <p class="mb-1"><strong>Date:</strong> ${startTime.toLocaleDateString()}</p>
                <p class="mb-1"><strong>Duration:</strong> ${Math.round((endTime - startTime) / (1000 * 60 * 60))} hours</p>
                <p class="mb-3"><strong>Cost:</strong> ${(props.cost || 0).toFixed(2)}</p>
                
                <h6><i class="fas fa-info-circle me-2"></i>Actions</h6>
                <p class="text-muted small">
                    ${props.status === 'pending' ? 'You can approve or reject this booking request.' :
                      props.status === 'confirmed' ? 'This booking is confirmed. You can cancel if needed.' :
                      'This booking has been processed.'}
                </p>
            </div>
        </div>
    `;
    
    // Set up action buttons based on status
    let actionButtons = '';
    if (props.status === 'pending') {
        actionButtons = `
            <button type="button" class="btn btn-success" onclick="updateBookingStatus('${event.id}', 'confirmed')">
                <i class="fas fa-check me-2"></i>Approve
            </button>
            <button type="button" class="btn btn-danger" onclick="updateBookingStatus('${event.id}', 'rejected')">
                <i class="fas fa-times me-2"></i>Reject
            </button>
        `;
    } else if (props.status === 'confirmed') {
        actionButtons = `
            <button type="button" class="btn btn-warning" onclick="updateBookingStatus('${event.id}', 'cancelled')">
                <i class="fas fa-ban me-2"></i>Cancel Booking
            </button>
        `;
    }
    
    actionsEl.innerHTML = actionButtons;
    
    // Show modal
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

async function updateBookingStatus(bookingId, newStatus) {
    try {
        const reason = newStatus === 'rejected' || newStatus === 'cancelled' ? 
            prompt(`Please provide a reason for ${newStatus}:`) : '';
        
        if ((newStatus === 'rejected' || newStatus === 'cancelled') && !reason) {
            return; // User cancelled
        }
        
        const response = await fetch(`/owner/booking/${bookingId}/${newStatus === 'confirmed' ? 'approve' : newStatus === 'rejected' ? 'reject' : 'cancel'}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: reason ? `reason=${encodeURIComponent(reason)}` : ''
        });
        
        if (response.ok) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
            modal.hide();
            
            // Reload calendar data
            await loadCalendarData();
            
            showSuccess(`Booking ${newStatus} successfully!`);
        } else {
            showError(`Failed to ${newStatus} booking`);
        }
    } catch (error) {
        console.error('Error updating booking status:', error);
        showError('Error updating booking status');
    }
}

function showError(message) {
    // Simple error notification - in production, use a proper notification library
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

function showSuccess(message) {
    // Simple success notification
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}

// Refresh calendar every 5 minutes
setInterval(loadCalendarData, 5 * 60 * 1000);
</script>
{% endblock %}